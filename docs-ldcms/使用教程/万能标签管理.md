# 万能标签管理

> 1.3.0之后的版本支持此功能。在模板二次开发时，当发现系统提供的标签不够用时，可以在此进行自定义标签。（当然自定义标签需要您有一定的SQL基础）

## 功能说明

万能标签管理是LDCMS提供的高级功能，允许开发者创建自定义的数据调用标签。这个功能特别适用于：

- 系统内置标签无法满足特殊需求时
- 需要复杂数据查询和关联时  
- 希望复用特定的数据逻辑时
- 需要调用外部数据源时

![万能标签管理界面](image.png)

## 方法名称

设置方法名称，指定标签方法名称（唯一）。

这个名称将作为模板中调用标签的标识符，格式为：`{ld:方法名称}`

![方法名称设置](image.png)

### 命名规范

- 只能使用字母、数字、下划线
- 必须以字母开头
- 名称要具有描述性
- 避免与系统内置标签重名

**示例命名：**
```
getLatestNews      # 获取最新新闻
getTopProducts     # 获取热门产品  
getCustomData      # 获取自定义数据
getUserStats       # 获取用户统计
```

## 方法类型

选择获取数据的类型，支持SQL与函数2种类型：

### SQL类型：表示SQL查询方式

适用于数据库查询操作，支持复杂的数据关联和筛选。

![SQL类型配置](image.png)

#### 主表配置

支持两种方式指定主表：

**1. Model方式：**
使用模型名称，系统会自动处理表前缀和关联关系。

![Model方式](image.png)

**示例：**
```
Document    # 对应 fa_ldcms_document 表
Category    # 对应 fa_ldcms_category 表
User        # 对应 fa_admin 表
```

**2. 表名称方式：**
直接指定数据库表名，需要包含表前缀。

![表名称方式](image.png)

**示例：**
```
fa_ldcms_document
fa_ldcms_category  
fa_admin
fa_user
```

#### 别名设置

建议填写别名，关联表的时候会用到。

![别名设置](image.png)

别名的作用：
- 简化SQL语句编写
- 便于多表关联时的字段引用
- 提高SQL可读性

**示例：**
```
主表：fa_ldcms_document  别名：d
主表：fa_ldcms_category  别名：c
主表：fa_admin           别名：a
```

#### 调用字段

填写需要调用的字段，`*` 表示所有字段。

![调用字段](image.png)

**字段配置示例：**
```
*                           # 所有字段
d.id,d.title,d.content     # 指定字段
d.*,c.name as category_name # 别名字段
COUNT(*) as total          # 聚合函数
```

#### JOIN关联

表示关联副表，用于多表查询。

**格式说明：**
```
表名称：关联的表
关联条件：主表的外键=副表的主键
join类型：INNER/LEFT/RIGHT
```

**JOIN类型说明：**
- **INNER**：如果表中有至少一个匹配，则返回行
- **LEFT**：即使右表中没有匹配，也从左表返回所有的行  
- **RIGHT**：即使左表中没有匹配，也从右表返回所有的行

![JOIN关联配置](image.png)

**关联配置示例：**
```
表名称：fa_ldcms_category
关联条件：d.cid = c.id
JOIN类型：LEFT

表名称：fa_admin  
关联条件：d.admin_id = a.id
JOIN类型：LEFT
```

### 函数方法：表示可以调用指定的模型或函数

适用于复杂的业务逻辑处理，可以调用PHP类方法或函数。

![函数方法配置](image.png)

#### 类配置

填写类的命名空间，如果是函数则不要填写。

![类配置](image.png)

**类命名空间示例：**
```
app\admin\model\ldcms\Document
app\common\model\User
addons\ldcms\model\Custom
```

#### 函数或方法

填写类的方法名称或函数名称。

![函数方法设置](image.png)

**接收传参示例：**
```php
getHomeList($params)
```

其中 `$params` 的值来自于下方的标签的传参。

**方法实现示例：**
```php
public function getHomeList($params) {
    $limit = isset($params['limit']) ? $params['limit'] : 10;
    $cid = isset($params['cid']) ? $params['cid'] : 0;
    
    $query = $this->where('status', 'normal');
    if ($cid > 0) {
        $query->where('cid', $cid);
    }
    
    return $query->limit($limit)->order('id desc')->select();
}
```

## 参数：自定义标签的参数

用于action标签的参数属性，定义标签调用时可以传递的参数。

![参数配置](image.png)

### 参数配置说明

**字段：** 表示数据库字段
**条件：** 查询条件（=, >, <, LIKE等）
**值：** 支持多种方式（后端直接填写、函数调用、前端调用时传值、填写SQL条件）
**前端传值：** 表示这个值需要在调用标签时进行传递，一般用于有二次处理的参数
**运算符：** AND/OR（条件且与或）

### 值的配置方式

#### 1. 后端直接填写

直接在配置中写死参数值，适用于固定条件。

![后端填写](image.png)

**示例：**
```
字段：status
条件：=  
值：normal
说明：查询状态为normal的记录
```

#### 2. 函数调用

使用PHP函数获取动态值，必须需要带`:`否则被当做字符串。

![函数调用](image.png)

**示例：**
```
字段：create_time
条件：>
值：:strtotime('-30 days')
说明：查询30天内的记录

字段：cid
条件：=
值：:getCurrentCategoryId()
说明：获取当前栏目ID
```

#### 3. 前端传值

标记为前端传值的参数，在模板中调用时必须传递。

![前端传值](image.png)

**使用方法：**
```html
{ld:getCustomData cid="1" limit="10"}
{volist name="item" id="vo"}
    <h3>{$vo.title}</h3>
{/volist}
{/ld:getCustomData}
```

#### 4. SQL条件

直接编写SQL条件语句，适用于复杂查询。

![SQL条件](image.png)

**示例：**
```
字段：id
条件：IN
值：(SELECT doc_id FROM fa_ldcms_document_tags WHERE tag_name='热门')
说明：查询包含'热门'标签的文档
```

## 实际应用示例

### 示例1：获取热门文章

**方法名称：** `getHotArticles`
**方法类型：** SQL
**主表：** Document  
**别名：** d
**调用字段：** d.id,d.title,d.views,d.create_time
**参数配置：**

| 字段 | 条件 | 值 | 前端传值 | 运算符 |
|------|------|----|---------|---------| 
| status | = | normal | 否 | AND |
| views | > | 100 | 否 | AND |
| limit | - | 10 | 是 | - |

**模板调用：**
```html
{ld:getHotArticles limit="5"}
{volist name="item" id="article"}
<div class="hot-article">
    <h3>{$article.title}</h3>
    <span>浏览量：{$article.views}</span>
    <time>{$article.create_time|date='Y-m-d'}</time>
</div>
{/volist}
{/ld:getHotArticles}
```

### 示例2：获取分类下的推荐产品

**方法名称：** `getRecommendProducts`
**方法类型：** SQL
**主表：** fa_ldcms_document
**别名：** d
**调用字段：** d.*,c.name as category_name
**JOIN关联：**
- 表名称：fa_ldcms_category
- 关联条件：d.cid = c.id  
- JOIN类型：LEFT

**参数配置：**

| 字段 | 条件 | 值 | 前端传值 | 运算符 |
|------|------|----|---------|---------| 
| d.cid | = | - | 是 | AND |
| d.flag | LIKE | %推荐% | 否 | AND |
| d.status | = | normal | 否 | AND |

**模板调用：**
```html
{ld:getRecommendProducts cid="$category.id"}
{volist name="item" id="product"}
<div class="product-item">
    <h4>{$product.title}</h4>
    <p>分类：{$product.category_name}</p>
    <img src="{$product.image}" alt="{$product.title}">
</div>
{/volist}
{/ld:getRecommendProducts}
```

### 示例3：调用自定义函数

**方法名称：** `getStatistics`
**方法类型：** 函数
**类：** app\admin\model\ldcms\Custom
**函数或方法：** getWebsiteStats

**PHP实现：**
```php
<?php
namespace app\admin\model\ldcms;

class Custom 
{
    public function getWebsiteStats($params) 
    {
        $stats = [];
        
        // 统计文章数量
        $stats['article_count'] = Document::where('status', 'normal')->count();
        
        // 统计栏目数量  
        $stats['category_count'] = Category::count();
        
        // 统计今日访问量
        $stats['today_views'] = Document::whereTime('create_time', 'today')->sum('views');
        
        return [$stats]; // 返回数组格式
    }
}
```

**模板调用：**
```html
{ld:getStatistics}
{volist name="item" id="stats"}
<div class="stats-panel">
    <div class="stat-item">
        <span class="number">{$stats.article_count}</span>
        <span class="label">文章总数</span>
    </div>
    <div class="stat-item">
        <span class="number">{$stats.category_count}</span>  
        <span class="label">栏目数量</span>
    </div>
    <div class="stat-item">
        <span class="number">{$stats.today_views}</span>
        <span class="label">今日浏览</span>
    </div>
</div>
{/volist}
{/ld:getStatistics}
```

## 调试与优化

### 调试方法

1. **开启调试模式：** 在config.php中设置`app_debug => true`
2. **查看SQL日志：** 检查生成的SQL语句是否正确
3. **使用dump输出：** 在模板中使用`{$item|dump}`查看数据结构
4. **逐步测试：** 先测试简单查询，再逐步增加复杂度

### 性能优化

1. **合理使用索引：** 确保查询字段有相应索引
2. **限制查询数量：** 使用limit控制返回数据量
3. **避免N+1查询：** 合理使用JOIN减少查询次数
4. **缓存查询结果：** 对于不经常变化的数据使用缓存

### 注意事项

1. **安全性：** 避免SQL注入，使用参数化查询
2. **权限控制：** 检查数据访问权限
3. **错误处理：** 添加适当的错误处理机制
4. **文档记录：** 记录自定义标签的用途和参数说明

---
*文档最后更新时间：2024-05-28*